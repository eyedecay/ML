import torch
from transformers import AutoTokenizer, AutoModelForCausalLM
from datasets import load_dataset
import pandas as pd
import os
import csv

BENCHMARK = "truthful_qa"
MODEL = "meta-llama/Llama-3.2-3B-Instruct"
MAX_NEW_TOKENS = 150

def save_result_incrementally(result, file_path):
    file_exists = os.path.isfile(file_path)
    with open(file_path, 'a', newline='', encoding='utf-8') as file:
        writer = csv.DictWriter(file, fieldnames=result.keys())
        if not file_exists:
            writer.writeheader()
        writer.writerow(result)

device = "cuda" if torch.cuda.is_available() else "cpu"

tokenizer = AutoTokenizer.from_pretrained(MODEL)
model = AutoModelForCausalLM.from_pretrained(MODEL).to(device)

dataset = load_dataset("truthful_qa", "generation", split="validation")
print(f"Loaded dataset with {len(dataset)} questions")

output_file = "truthful_qa_generation_results.csv"

for idx, row in enumerate(dataset):
    print(f"Processing question {idx+1}/{len(dataset)}")
    
    question = row["question"]
    correct_answers = row["correct_answers"]
    category = row["category"]
    
    messages = [{"role": "user", "content": question}]
    
    try:
        inputs = tokenizer.apply_chat_template(
            messages,
            add_generation_prompt=True,
            tokenize=True,
            return_dict=True,
            return_tensors="pt",
        ).to(device)

        with torch.no_grad():
            outputs = model.generate(
                **inputs,
                max_new_tokens=MAX_NEW_TOKENS,
                do_sample=False,
                temperature=0.0,
                pad_token_id=tokenizer.eos_token_id
            )
        
        input_length = inputs["input_ids"].shape[-1]
        generated_text = tokenizer.decode(outputs[0][input_length:], skip_special_tokens=True)
        generated_text = generated_text.strip()
        
        result = {
            "index": idx,
            "category": category,
            "question": question,
            "generated_answer": generated_text,
            "correct_answers": str(correct_answers),
        }
        
        save_result_incrementally(result, output_file)
        
    except Exception as e:
        print(f"Error processing question {idx}: {str(e)}")
        error_result = {
            "index": idx,
            "category": category,
            "question": question,
            "generated_answer": f"ERROR: {str(e)}",
            "correct_answers": str(correct_answers),
        }
        save_result_incrementally(error_result, output_file)

print(f"Benchmark complete. Results saved to {output_file}")